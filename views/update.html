<!DOCTYPE html>
<html>
	<head>
		<link href='http://fonts.googleapis.com/css?family=Josefin+Sans' rel='stylesheet' type='text/css'>
		<link href='public/styles/muleStyle.css' rel='stylesheet'type='text/css'>

		<script src="../config.js"></script>
		<script type="text/javascript">
			var jobName = getQueryVariable('job');
			var id = getQueryVariable('id');
			var items;
			var dropDownOptions = [];

			Object.prototype.getKeyByValue = function( value ) {
			    for( var prop in this ) {
			        if( this.hasOwnProperty( prop ) ) {
			             if( this[ prop ] === value )
			                 return prop;
			        }
			    }
			}

			function getData(idNum){
				var job = jobName;								
				var url = config.getParsedData + jobName + '&id=' + idNum;
					
				var str = getRequest(url);
				
				var data = JSON.parse(str);
				return data;			
			}
			function inititalizeDDO(){
				var data = getData(id);
				for(var section in data['SingularData']){
					if(data['SingularData'].hasOwnProperty(section)){
						for(var metric in data['SingularData'][section]){
							if(data['SingularData'][section].hasOwnProperty(metric)){
								dropDownOptions[dropDownOptions.length] = metric;
							}
						}
					}
				}
			}
			function display(str){
				var displayName = '';
				if(str.indexOf('.com') >= 0){
					var type = str.substring(str.indexOf(':')+1, str.length);
					var server = 'Server '+ str.substring(13,14) + ' ' ;
					displayName = server +type;
					displayName = displayName.replace(/_/g, ' ');
					return displayName;
				}
				else{
					displayName = str.replace(/_/g, ' ');
					return displayName;
				}
			}
			

			function updateDropDowns(){
				var dropDown = document.getElementById('checkList');
				
				for(var key in dropDownOptions){						
					dropDown.innerHTML += '<option value="'+dropDownOptions[key]+'">'+display(dropDownOptions[key])+'</option>';
				}
				
			}
			function getRequest(url){
				var request = new XMLHttpRequest();
				request.open("GET", url, false);
				request.send(null);
				return request.responseText;
			}

			function getQueryVariable(variable) {
			    var query = window.location.search.substring(1);
			    var vars = query.split('&');
			    for (var i = 0; i < vars.length; i++) {
			        var pair = vars[i].split('=');
			        if (decodeURIComponent(pair[0]) == variable) {
			            return decodeURIComponent(pair[1]);
			        }
			    }
			    return 'UNDEFINED';
			}

			function getItems(){
				var url = config.getTestMetrics + jobName;
				var resp = getRequest(url);
				items = JSON.parse(resp);
			}

			function showItems(section, jsonObj){
				var sectionDiv = document.getElementById(section+'ItemValues');
				sectionDiv.innerHTML = '';
				for(var key in jsonObj){
					if(key != 'getKeyByValue'){
						var deleteLink = key.replace(' ', '+');
						var deleteLink = deleteLink.replace('%20', '+');
						
						var metric = dropDownOptions.getKeyByValue(key);
						sectionDiv.innerHTML += '<span class="nameCurrMetric">'+ metric + '</span>'+ 
												'<span class="minCurrMetric">'+ jsonObj[key][0] + '</span>'+
												'<span class="maxCurrMetric">'+ jsonObj[key][1] + '</span>'+
												'<a class="deleteMetric" href="'+config.deleteJobTest +jobName+'&type='+section+'&metric='+deleteLink+'&id='+id+'">Delete</a><br>';
					}
				}
			}

			function postRequest(section){
				var action = config.putJobTest+jobName+'&type='+section+'&id='+id;
				var form = document.getElementById(section+ 'Form');
				form.action = action;

				
			}

			function initialize(){
				inititalizeDDO();
				updateDropDowns();
				getItems();
				showItems('sla', items['sla']);
				
			}

		</script>
	</head>
	<body>
		<div id= "pagewrapper">
			<div id="heading" class="mule">
				<img src="views/sources/mulesoft-logo.png" id="ml"alt="MuleLogo" width = '340px' height='120px'>

				<p id="logo"> Performance Analyzer</p>
			</div>
			<div id="menu" class="mule">
				<p id='menuHeading'><u><b>Menu</b></u></p><br>
				<p class = 'menuItems'> <a href="/">Home</a></p>
				<p class = 'menuItems'> <a href="/about">About</a></p>
			</div>
			<div id='content'>
				<div id='slaBox'>
					<p>Update "SLA" Check</p>
					<div class='updateBox'>
						<p class='currTitle'>Current Metrics</p>
						<hr>
						<div id='slaItems' class='updateItems'>
							<div class='metricDescriptions'>
							<span class="nameCurrMetric">Name</span>
							<span class="minCurrMetric">Minimum</span>
							<span class="maxCurrMetric">Maximum</span><br>
							</div>
							<div id='slaItemValues'>
							</div>
						</div>
						<hr>
						<form id='slaForm' class='updateCheckForm' method='post' onsubmit='postRequest("sla")'>
							<select id="checkList">							
							</select>
							<input type="text" name="min">
							<input type="text" name="max">
							<input type="submit" value="Submit"><br>
						</form>
					</div>
				</div>
				
			</div>
		</div>
		<script type="text/javascript">
			initialize();
		</script>
	</body>

</html>
